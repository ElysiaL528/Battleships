<html> 
    <head>
        <title>Room:</title>

        <style>
         
        </style>
        
    </head>
    <body onload = "drawGrids();">
        <h3></h3>
        <div id="gridPlaceHolder"></div>
            <button id="donePlacingShips" onclick="SetPlayerReady();">Done Placing</button>
        <button id="randomizeButton" onclick="RandomizeShips();">Randomize ship placement</button>
    </body>
</html>
<script src ="Cell.js"></script>
<script>
//Test checkReady function
//Create randomize ships function (for quicker debugging)
//Figure out why the page keeps crashing after both players are done placing
var cellsMap = new Map();
var playerShipsMap = new Map();

var placedShipsCells = new Map();
var placedShipsIDs = new Map();

var selectedShipID;
var selectedShipLength = 0;

localStorage.getItem('RoomName');

function drawGrids()
{
    let gameBoard = document.createElement('table');
    gameBoard.id = 'grid';
    gameBoard.style.outline = '1px solid Black';
    
    document.body.appendChild(gameBoard);

    let gridCellSize = 50;

    for(let y = 1; y <= 10; y++)
    {
        let row = document.createElement('tr');
        gameBoard.appendChild(row);
        for(let x = 1; x <= 10; x++)
        {
            let cell = document.createElement('td');
            cell.id = `x${x}y${y}`;
            cell.style.width = `${gridCellSize}px`;
            cell.style.height = `${gridCellSize}px`;
            cell.style.outline = '1px solid Black';
            cell.onmouseover = () =>    {
                                            if(cell.dataset.isSelected == "false" && cell.dataset.isAvailableCell == 'false') 
                                            {
                                                cell.style.backgroundColor = 'LightBlue'; 
                                            }
                                        };
            cell.onmouseout = () => {
                                            if(cell.dataset.isSelected == "false" && cell.dataset.isAvailableCell == 'false')
                                            {
                                                cell.style.backgroundColor = 'Transparent';
                                            }
                                    };
            cell.onclick = () => { if(selectedShipID != null && placedShipsIDs.get(selectedShipID) == null) {selectedCell(cell.id); }};
            cell.dataset.isSelected = 'false';
            cell.dataset.x = x;
            cell.dataset.y = y;
            cell.dataset.isAvailableCell = 'false';
            cell.dataset.isShip = 'false';
            cellsMap.set(cell.id, cell);    
            row.appendChild(cell);
        }
    }

    let shipsGrid = document.createElement('table');
    shipsGrid.id = 'shipsGrid';
    shipsGrid.style.outline = '1px solid Black';

    shipsGrid.style.position = 'relative';
    shipsGrid.style.top = '50px';

    document.body.appendChild(shipsGrid);
    for(let i = 1; i <= 5; i++)
    {
        let shipsRow = document.createElement('tr');
        shipsGrid.appendChild(shipsRow);
        
        let shipsCell = document.createElement('td');

        switch(i)
        {
            case 1:
                shipsCell.id = 1;
                shipsCell.dataset.name = 'AircraftCarrier';
                shipsCell.dataset.shipLength = 5;
                break;

            case 2:
                shipsCell.id = 2;
                shipsCell.dataset.name = 'Battleship';
                shipsCell.dataset.shipLength = 4;
                break;

            case 3:
                shipsCell.id = 3;
                shipsCell.dataset.name = 'Submarine';
                shipsCell.dataset.shipLength = 3;
                break;
            
            case 4:
                shipsCell.id = 4;
                shipsCell.dataset.name = 'Cruiser';
                shipsCell.dataset.shipLength = 3;
                break;
            
            case 5:
                shipsCell.id = 5;
                shipsCell.dataset.name = 'Destroyer';
                shipsCell.dataset.shipLength = 2;
                break;
        }
        shipsCell.style.width = '500px';
        shipsCell.style.height = '50px';
        shipsCell.style.outline = '1px solid Black';
        
        shipsCell.onmouseover = () =>   { 
                                            if(shipsCell.dataset.isSelected == 'false')
                                            {    
                                                shipsCell.style.backgroundColor = 'LightGreen';
                                            }
                                        };
        shipsCell.onmouseout = () => {  if(shipsCell.dataset.isSelected == 'false')
                                        {
                                            shipsCell.style.backgroundColor = 'Transparent';
                                        }
                                    };

        shipsCell.onclick = () => { selectedShipsCell(shipsCell.id); };
        playerShipsMap.set(shipsCell.id, shipsCell);
        shipsRow.appendChild(shipsCell);

        shipsCell.dataset.isSelected = 'false';

    }
    let donePlacingButton = document.createElement('button');
    donePlacingButton.style.backgroundColor = 'LightGreen';
}


var availableEndCells = new Map();
var startCellX = 0;
var startCellY = 0;
var orientationID = 0;


function PlaceShip(cell, shipOrientationID, shipTypeID, alertIfInvalid)
{
    var info = {
            RoomID: localStorage.getItem('RoomID'),
            UserID: localStorage.getItem('UserID'),
            ShipTypeID: shipTypeID,
            StartX: startCellX,
            StartY: startCellY,
            ShipOrientationID: shipOrientationID
        };
        switch(shipTypeID)
        {
            case "1":
                selectedShipLength = 5;
                break;
            case "2":
                selectedShipLength = 4;
                break;
            case "3":
                selectedShipLength = 3; 
                break;
            case "4":
                selectedShipLength = 3;
                break;
            case "5":
                selectedShipLength = 2;
                break;
        }
        callAPI("http://localhost:63055/api/Game/PlaceShip", (message) => {
            if(message == "Placed ship")
            {
                if(shipOrientationID == 1 || shipOrientationID == 2) //Up or down
                {
                    let value = shipOrientationID == 1 ? cell.dataset.y : startCellY;
                    let changeInI = shipOrientationID == 1 ? 1 : -1;
                    for(let i = asInt(value); asInt(i) < (asInt(value) + asInt(selectedShipLength)); i++)
                    {
                        let tempCell = cellsMap.get(`x${cell.dataset.x}y${i}`);
                        tempCell.style.backgroundColor = 'DarkBlue';
                        tempCell.dataset.isSelected = 'true';
                        tempCell.dataset.isShip = 'true';
                        placedShipsCells.set(`${tempCell.id}`, selectedShipID);
                    }
                }
                else if(shipOrientationID == 3 || shipOrientationID == 4)
                {
                    let value = shipOrientationID == 3 ? cell.dataset.x : startCellX;
                    let changeInI = shipOrientationID == 3 ? 1 : -1;
                    for(let i = asInt(value); asInt(i) < (asInt(value) + asInt(selectedShipLength)); i++)
                    {
                        let tempCell = cellsMap.get(`x${i}y${cell.dataset.y}`);
                        tempCell.style.backgroundColor = 'DarkBlue';
                        tempCell.dataset.isSelected = 'true';
                        tempCell.dataset.isShip = 'true';
                        placedShipsCells.set(`${tempCell.id}`, selectedShipID);
                    }
                    
                }
                
                for(let y = 1; y < 11; y++)
                {
                    for(let x = 1; x < 11; x++)
                    {
                        let cell = cellsMap.get(`x${x}y${y}`);
                        if(cell.dataset.isShip != "true")
                        {
                            cell.style.backgroundColor = 'White';
                            cell.isSelected = 'false';
                            cell.isAvailableCell = 'false';
                        }

                        //Remove previous available end cells
                        availableEndCells.set('UpperEndCell', null);
                        availableEndCells.set('LowerEndCell', null);
                        availableEndCells.set('RightEndCell', null);
                        availableEndCells.set('LeftEndCell', null);
                        
                    }
                }
                placedShipsIDs.set(selectedShipID, 1); //Records that we placed this type of ship (value doesn't matter)
                playerShipsMap.get(selectedShipID).style.backgroundColor = 'LightBlue';
            }
            else if(alertIfInvalid == true)
            {
                alert(message);
            }
            else
            {
                //Randomizes placement again
                startCellX = Math.floor(Math.random() * 10 + 1);
                startCellY = Math.floor(Math.random() * 10 + 1);
                orientationID = Math.floor(Math.random() * 4 + 1);

                let cell = cellsMap.get(`x${startCellX}y${startCellY}`);

                PlaceShip(cell, orientationID, false);
            }
        }, info);
}


function selectedCell(cellID)
{
    //Displays all the available end cells
    let cell = cellsMap.get(cellID);    
    if(cell.dataset.isAvailableCell == "true")
    {
        //This happens when the player chooses an end cell for a ship

        let shipOrientationID = 0;
        if(availableEndCells.get('UpperEndCell') == cell)
        {
            shipOrientationID = 1;
        }
        else if(availableEndCells.get('LowerEndCell') == cell)
        {
            shipOrientationID = 2;
        }
        else if(availableEndCells.get('LeftEndCell') == cell)
        {
            shipOrientationID = 3;
        }
        else
        {
            shipOrientationID = 4;
        }
        PlaceShip(cell, shipOrientationID, selectedShipID, true);
    }
    else
    {        
        if(selectedShipID != null)
        {
            for(let y = 1; y < 11; y++)
            {
                for(let x = 1; x < 11; x++)
                {
                    let cell = cellsMap.get(`x${x}y${y}`);
                    if(cell.dataset.isShip != "true")
                    {
                        cell.style.backgroundColor = 'White';
                        cell.dataset.isSelected = 'false';
                        cell.dataset.isAvailableCell = 'false';
                    }

                    //Remove previous available end cells
                    availableEndCells.set('UpperEndCell', null);
                    availableEndCells.set('LowerEndCell', null);
                    availableEndCells.set('RightEndCell', null);
                    availableEndCells.set('LeftEndCell', null);
                    
                }
            }

            cell.dataset.isSelected = "true";

            cell.style.backgroundColor = 'DarkBlue';
            startCellX = cell.dataset.x;
            startCellY = cell.dataset.y;
        
            if(asInt(cell.dataset.x) - asInt(selectedShipLength) + 1 > 0)
            {
                let cellID = `x${asInt(cell.dataset.x) - asInt(selectedShipLength) + 1}y${cell.dataset.y}`;
                if(placedShipsCells.get(cellID) == null) //If the end cell doesn't coincide with another ship...
                {
                    let availableCell = cellsMap.get(cellID);        
                    setAvailableCell('LeftEndCell', availableCell);
                }
            }
            if(asInt(cell.dataset.x) + asInt(selectedShipLength) - 1 < 11)
            {
                let cellID = `x${asInt(cell.dataset.x) + asInt(selectedShipLength) - 1}y${cell.dataset.y}`;
                if(placedShipsCells.get(cellID) == null)
                {
                    let availableCell = cellsMap.get(cellID);
                    setAvailableCell('RightEndCell', availableCell);
                }
            }
            if(asInt(cell.dataset.y) - asInt(selectedShipLength) + 1 > 0)
            {
                let cellID = `x${cell.dataset.x}y${asInt(cell.dataset.y) - asInt(selectedShipLength) + 1}`;
                if(placedShipsCells.get(cellID) == null)
                {
                    let availableCell = cellsMap.get(cellID);
                    setAvailableCell('UpperEndCell', availableCell);
                }
            }
            if(asInt(cell.dataset.y) + asInt(selectedShipLength) - 1 < 11)
            {
                let cellID = `x${cell.dataset.x}y${asInt(cell.dataset.y) + asInt(selectedShipLength) - 1}`;
                if(placedShipsCells.get(cellID) == null)
                {
                    let availableCell = cellsMap.get(cellID);
                    setAvailableCell('LowerEndCell', availableCell);
                }
            }
        }
    }
}

function setAvailableCell(key, availableCell)
{
    availableCell.dataset.isAvailableCell = 'true';
    availableCell.style.backgroundColor = 'LightBlue';
    availableEndCells.set(`${key}`, availableCell);
}

function asInt(value)
{
    //Casts value as integer
    return value * 1;
}

function selectedShipsCell(cellID)
{
    let cell = playerShipsMap.get(cellID);

    for(let i = 1; i < 6; i++)
    {
        let temp = playerShipsMap.get(`${i}`);
        if(placedShipsIDs.get(temp.id) == null)
        {
            temp.style.backgroundColor = 'White';
        }
        temp.isSelected = 'false';
    }

    

    if(placedShipsIDs.get(cellID) == null)
    {
        for(let y = 1; y < 11; y++)
            {
                for(let x = 1; x < 11; x++)
                {
                    let cell = cellsMap.get(`x${x}y${y}`);
                    if(cell.dataset.isShip != "true")
                    {
                        cell.style.backgroundColor = 'White';
                        cell.dataset.isSelected = 'false';
                        cell.dataset.isAvailableCell = 'false';
                    }

                    //Remove previous available end cells
                    availableEndCells.set('UpperEndCell', null);
                    availableEndCells.set('LowerEndCell', null);
                    availableEndCells.set('RightEndCell', null);
                    availableEndCells.set('LeftEndCell', null);
                    
                }
            }

        cell.dataset.isSelected = 'true';
        cell.style.backgroundColor = 'LightGreen';

        selectedShipID = cellID;
        selectedShipLength = cell.dataset.shipLength;
    }
    else
    {
        cell.style.backgroundColor = 'LightBlue';
    }
}

function RandomizeShips()
{
    //Delete any pre-existing ships
    
    let placedShip = false;
    
    var interval;
    /*
    for(let i = 1; i < 5; i++)
    {
        interval = window.setInterval(() => 
        {
            startCellX = Math.floor(Math.random() * 10 + 1);
            startCellY = Math.floor(Math.random() * 10 + 1);
            let orientationID = Math.floor(Math.random() * 4 + 1);

            let cell = cellsMap.get(`x${startCellX}y${startCellY}`);

            selectedShipID = i;

            PlaceShip(cell, orientationID, false);   

            if(placedShipsIDs.get(i) == 1) //i is the ship type ID
            {
                placedShip = true;
                window.clearInterval();
            }
        }, 1000);
    }*/

        startCellX = Math.floor(Math.random() * 10 + 1);
        startCellY = Math.floor(Math.random() * 10 + 1);
        orientationID = Math.floor(Math.random() * 4 + 1);

        let cell = cellsMap.get(`x${startCellX}y${startCellY}`);

        selectedShipID = "1";
        PlaceShip(cell, orientationID, selectedShipID, false);

        //debug in SQL why a ship can be placed where the starting coord: (1, 1) and orientation is up
        //finish randomizing placements for all ships
}

var checkReadyInterval;
function SetPlayerReady()
{
    if(placedShipsIDs.size == 5)
    {
        window.location.href = "./Gameplay.html";
    }
    else
    {
        alert("Didn't place all ships");
    }
}
function callAPI(url, callback, body)
    {
        var xhr = new XMLHttpRequest();
        xhr.open(body === undefined ? 'GET' : 'POST', url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onload = () => callback(JSON.parse(xhr.responseText));

        if(body === undefined)
        {
            xhr.send();
        }
        else
        {
            xhr.send(JSON.stringify(body));
        }
    }
    
</script>