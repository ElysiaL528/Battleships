<html>
    <head>
        <title>Battleships</title>
        <head>

        </head>
        <body onload="WaitUntilOpponentReady();">
            <p id="waitingText">Waiting for opponent ready...</p>
            <div id="playerShips"></div>
            <div id="playerAttacks"></div>
        </body>
    </head>
</html>
<script>
    
    var selectedCells = new Map();

    var waitingText = document.getElementById("waitingText");
    function WaitUntilOpponentReady()
    {   
        document.body.appendChild(waitingText);
        var info = {
                PlayerID: localStorage.getItem('UserID'),
                RoomID: localStorage.getItem('RoomID')
            };

            callAPI("http://localhost:63055/api/Game/SetReady", () => {
                //Wait for other player ready
                checkReadyInterval = window.setInterval(() => {
                    callAPI("http://localhost:63055/api/Game/CheckReady", (opponentReadyStatus) => {
                        if(opponentReadyStatus == "True")
                        {
                            window.clearInterval(checkReadyInterval);
                            waitingText.style.display = "none";
                            Gameplay();
                        }
                    }, info)
                    }, 5000);
                }, info);
    }
    function DrawGrids()
    {
        //Player attacks 
        let playerShotsBoard = document.createElement('table');
        playerShotsBoard.id = 'playerShotsBoard';
        playerShotsBoard.style.outline = '1px solid Black';

        document.body.appendChild(playerShotsBoard);

        let gridCellSize = 50;

        for(let y = 1; y <= 10; y++)
        {
            let row = document.createElement('tr');
            playerShotsBoard.appendChild(row);
            for(let x = 1; x <= 10; x++)
            {
                let cell = document.createElement('td');

                cell.id = `playerShotsx${x}y${y}`;
                cell.style.width = `${gridCellSize}px`;
                cell.style.height = `${gridCellSize}px`;
                cell.style.outline = `1px solid Black`;
                cell.onmouseover = () =>    {
                                                // if(cell.dataset.isSelected == "false" && cell.dataset.isAvailableCell == 'false') 
                                                // {
                                                //     cell.style.backgroundColor = 'LightBlue';
                                                // }
                                                cell.style.backgroundColor = 'LightBlue';
                                            };
                cell.onmouseout = () => {
                                            // if(cell.dataset.isSelected == "false" && cell.dataset.isAvailableCell == 'false') 
                                            // {
                                            //     cell.style.backgroundColor = 'Transparent'; 
                                            // }
                                            cell.style.backgroundColor = 'Transparent'; 
                                        };
                cell.onclick = () => { fireShot(cell.id)};
                cell.dataset.x = x;
                cell.dataset.y = y;
                cell.dataset.isSelected = false;
                row.appendChild(cell);
            }
        }

        //Opponent's attacks

        let opponentAttacksBoard = document.createElement("table");
        opponentAttacksBoard.id = "opponentAttacksBoard";
        opponentAttacksBoard.style.outline = "1px solid Black";

        for(let y = 1; y <= 10; y++)
        {
            let row = document.createElement("tr");
            opponentAttacksBoard.appendChild(row);
            for(let x = 1; x <= 10; x++)
            {
                let cell = document.createElement("td");
                cell.id = `opponentAttacksx${x}y${y}`;
                cell.style.width = `${gridCellSize}px`;
                cell.style.height = `${gridCellSize}px`;
                cell.style.outline = "1px solid Black";
                cell.dataset.x = x;
                cell.dataset.y = y;
                cell.dataset.status = "Neutral"; //"Neutral" if the opponent hasn't selected it yet, otherwise it's "Hit" or "Miss"
                //Modify the stored proc so the user knows when they sink a ship

                row.appendChild(cell);
            }
        }
    }

    function Gameplay()
    {
        DrawGrids();
    }

    function asInt(value)
    {
    //Casts value as integer
    return value * 1;
    }

    function fireShot(cellID)
    {
        let cell = document.getElementById(cellID);
        let x = cell.dataset.x;
        let y = cell.dataset.y;

        let info = {
            UserID: localStorage.getItem('UserID'),
            RoomID: localStorage.getItem('RoomID'),
            ShotX: x,
            ShotY: y
        };
        
        if(selectedCells.get(cellID) == null) //Ensures that the cell hasn't already been selected yet
        {
            callAPI("http://localhost:63055/api/Game/Shoot", (message) => 
            {
                if(message == "Miss")
                {
                    cell.style.backgroundColor = 'White';
                    selectedCells.set(cellID, "M");
                }
                else
                {
                    cell.style.backgroundColor = 'Red';
                    selectedCells.set(cellID, "H");
                }
            }, info);
        }
        
    }
    
    function callAPI(url, callback, body)
    {
        var xhr = new XMLHttpRequest();
        xhr.open(body === undefined ? 'GET' : 'POST', url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onload = () => callback(JSON.parse(xhr.responseText));

        if(body === undefined)
        {
            xhr.send();
        }
        else
        {
            xhr.send(JSON.stringify(body));
        }
    }
</script>