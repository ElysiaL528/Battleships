<html>
    <head>
        <title>Battleships</title>
        <head>

        </head>
        <body onload="WaitUntilOpponentReady();">
            <p id="waitingText">Waiting for opponent ready...</p>
            <div id="playerShips"></div>
            <div id="playerAttacks"></div>
        </body>
    </head>
</html>
<script>
    
    var isPlayerTurn = false;
    var gameOver = false;
    var sunkShipTypeID;
    var selectedCells = new Map();
    var waitingText = document.getElementById("waitingText");
    async function WaitUntilOpponentReady()
    {   
        document.body.appendChild(waitingText);
        let info = {
                PlayerID: localStorage.getItem('UserID'),
                RoomID: localStorage.getItem('RoomID')
            };

            // callAPI("http://localhost:63055/api/Game/SetReady", () => {
            //     //Wait for other player ready
            //     checkReadyInterval = window.setInterval(() => {
            //         callAPI("http://localhost:63055/api/Game/CheckReady", (opponentReadyStatus) => {
            //             if(opponentReadyStatus == "True")
            //             {
            //                 window.clearInterval(checkReadyInterval);
            //                 waitingText.style.display = "none";
            //                 Gameplay();
            //             }
            //         }, info)
            //         }, 5000);
            //     }, info);

        let opponentJoined = "false";
        
        while(opponentJoined == "false")
        {
            opponentJoined = await callAPI("http://localhost:63055/api/Game/SetReady", info);
        }
        //window.clearInterval(checkReadyInterval);
        waitingText.style.display = "none";
        Gameplay();
    }
    function DrawGrids()
    {
        //Player attacks 
        let playerShotsBoard = document.createElement('table');
        playerShotsBoard.id = 'playerShotsBoard';
        playerShotsBoard.style.outline = '1px solid Black';

        document.body.appendChild(playerShotsBoard);

        let gridCellSize = 50;

        for(let y = 1; y <= 10; y++)
        {
            let row = document.createElement('tr');
            playerShotsBoard.appendChild(row);
            for(let x = 1; x <= 10; x++)
            {
                let cell = document.createElement('td');

                cell.id = `playerShotsx${x}y${y}`;
                cell.style.width = `${gridCellSize}px`;
                cell.style.height = `${gridCellSize}px`;
                cell.style.outline = `1px solid Black`;
                cell.onmouseover = () =>    {
                                                if(cell.dataset.isSelected == "false") 
                                                {
                                                    cell.style.backgroundColor = 'LightBlue';
                                                }
                                            };
                cell.onmouseout = () => {
                                            if(cell.dataset.isSelected == "false") 
                                            {
                                                cell.style.backgroundColor = 'Transparent'; 
                                            }
                                        };
                cell.onclick = () => { fireShot(cell.id)};
                cell.dataset.x = x;
                cell.dataset.y = y;
                cell.dataset.isSelected = false;
                row.appendChild(cell);
            }
        }

        //Opponent's attacks

        let opponentAttacksBoard = document.createElement("table");
        opponentAttacksBoard.id = "opponentAttacksBoard";
        opponentAttacksBoard.style.outline = "1px solid Black";

        for(let y = 1; y <= 10; y++)
        {
            let row = document.createElement("tr");
            opponentAttacksBoard.appendChild(row);
            for(let x = 1; x <= 10; x++)
            {
                let cell = document.createElement("td");
                cell.id = `opponentAttacksx${x}y${y}`;
                cell.style.width = `${gridCellSize}px`;
                cell.style.height = `${gridCellSize}px`;
                cell.style.outline = "1px solid Black";
                cell.dataset.x = x;
                cell.dataset.y = y;

                row.appendChild(cell);
            }
        }
    }

    var LastShotID;
    async function Gameplay()
    {
        DrawGrids();
        // if(localStorage.getItem("IsHost") == "true")
        // {
        //     isPlayerTurn = true;
        // }
        // else
        // {
        //     isPlayerTurn = false;
        // }
        // LastShotID = -1;
        // while(!gameOver)
        // {
        //     if(!isPlayerTurn)
        //     {
        //         let lastShotInfo = 
        //         {
        //             RoomID: localStorage.getItem("RoomID"),
        //             LastShotID: LastShotID
        //         };
        //         //Record the coordinates of the shot and set it to the player's turn
        //         let shotCoordinates = await callAPI("http://localhost:63055/api/Game/NewShots", lastShotInfo);

        //         if(shotCoordinates != null)
        //         {

        //         }
        //     }
        // }
    }

    function asInt(value)
    {
        //Casts value as integer
        return value * 1;
    }

    function fireShot(cellID)
    {
        if(isPlayerTurn = true)
        {
            let cell = document.getElementById(cellID);
            let x = cell.dataset.x;
            let y = cell.dataset.y;

            let info = {
                UserID: localStorage.getItem('UserID'),
                RoomID: localStorage.getItem('RoomID'),
                X: x,
                Y: y
            };
            
            if(cell.dataset.isSelected = "false") //Ensures that the cell hasn't already been selected yet
            {
                cell.dataset.isSelected = "true";
                callAPI("http://localhost:63055/api/Game/Shoot", (message) => 
                {
                    switch(message)
                    {
                        case "Miss":
                            cell.style.backgroundColor = 'Gray';
                            selectedCells.set(cellID, "M");
                        break;

                        case "Hit":
                            cell.style.backgroundColor = 'Red';
                            selectedCells.set(cellID, "H");
                        break;

                        case "Pre-existing shot":
                            //Do nothing
                        break;

                        default:
                            cell.style.backgroundColor = 'Red';
                            sunkShipTypeID = message;
                        break;
                    }

                }, info);
            }
        }
        else
        {
            alert("Not your turn");
        }
        
    }
    
    function callAPI(url, body)
    {
        return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open(body === undefined ? 'GET' : 'POST', url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onload = () => {
                resolve(JSON.parse(xhr.responseText));
            };

            xhr.onerror = reject;
            xhr.onabort = reject;

            if(body === undefined)
            {
                xhr.send();
            }
            else
            {
                xhr.send(JSON.stringify(body));
            }
        });
    }
</script>