<html>
    <head>
        <title>Battleships</title>
        <head>

        </head>
        <body onload="WaitUntilOpponentReady();">
            <p id="waitingText">Waiting for opponent ready...</p>
            <div id="playerShips"></div>
            <div id="playerAttacks"></div>
        </body>
    </head>
</html>
<script>

    var isPlayerTurn = false;
    var gameOver = false;
    var sunkShipTypeID;
    var selectedCells = new Map();
    var opponentHits = 0;
    var playerHits = 0;
    var shipCells = new Map();
    var waitingText = document.getElementById("waitingText");
    async function WaitUntilOpponentReady()
    {   
        document.body.appendChild(waitingText);
        let info = {
                PlayerID: localStorage.getItem('UserID'),
                RoomID: localStorage.getItem('RoomID')
            };

            const promise = await callAPI("http://localhost:63055/api/Game/SetReady", info);
            //Wait for other player ready
            checkReadyInterval = window.setInterval(() => {
                    const promise = callAPI("http://localhost:63055/api/Game/CheckReady", info);
                    promise.then((opponentReadyStatus) => {
                        if(opponentReadyStatus == "True")
                        {
                            window.clearInterval(checkReadyInterval);
                            waitingText.style.display = "none";
                            DrawShipsAndGrids();
                            
                            if(localStorage.getItem("IsHost") == "true")
                            {
                                isPlayerTurn = true;
                            }
                            else
                            {
                                isPlayerTurn = false;
                            }
                            
                            WaitUntilTurn();
                        }
                        })
                    }, 2000);

        let opponentJoined = "false";
        let checkForOpponent;
        
        waitingText.style.display = "none";
    }
    function asInt(value)
    {
        return value*1;
    }

    async function DrawShipsAndGrids()
    {
        //DRAW GRIDS

        let gridCellSize = 50;

        //Player attacks 
        let playerShotsBoard = document.createElement('table');
        playerShotsBoard.id = 'playerShotsBoard';
        playerShotsBoard.style.outline = '1px solid Black';

        document.body.appendChild(playerShotsBoard);

        for(let y = 1; y <= 10; y++)
        {
            let row = document.createElement('tr');
            playerShotsBoard.appendChild(row);
            for(let x = 1; x <= 10; x++)
            {
                let cell = document.createElement('td');

                cell.id = `playerShotsx${x}y${y}`;
                cell.style.width = `${gridCellSize}px`;
                cell.style.height = `${gridCellSize}px`;
                cell.style.outline = `1px solid Black`;
                cell.onmouseover = () =>    {
                                                if(cell.dataset.isSelected == "false") 
                                                {
                                                    cell.style.backgroundColor = 'LightBlue';
                                                }
                                            };
                cell.onmouseout = () => {
                                            if(cell.dataset.isSelected == "false") 
                                            {
                                                cell.style.backgroundColor = 'Transparent'; 
                                            }
                                        };
                cell.onclick = () => { fireShot(cell.id)};
                cell.dataset.x = x;
                cell.dataset.y = y;
                cell.dataset.isSelected = false;
                row.appendChild(cell);
            }
        }

        //Opponent's attacks

        let opponentAttacksBoard = document.createElement('table');
        opponentAttacksBoard.id = 'opponentAttacksBoard';
        opponentAttacksBoard.style.outline = '1px solid Black';

        opponentAttacksBoard.style.position = 'relative';
        opponentAttacksBoard.style.left = '600px';
        opponentAttacksBoard.style.position = 'absolute'; 
        opponentAttacksBoard.style.top = '8px';

        document.body.appendChild(opponentAttacksBoard);

        for(let y = 1; y <= 10; y++)
        {
            let row = document.createElement('tr');
            opponentAttacksBoard.appendChild(row);
            for(let x = 1; x <= 10; x++)
            {
                let cell = document.createElement('td');
                cell.id = `opponentAttacksx${x}y${y}`;
                cell.style.width = `${gridCellSize}px`;
                cell.style.height = `${gridCellSize}px`;
                cell.style.outline = '1px solid Black';
                cell.dataset.x = x;
                cell.dataset.y = y;

                row.appendChild(cell);
            }
        }

        //Status label

        let statusLabel = document.createElement("p");
        document.body.appendChild(statusLabel);
        if(localStorage.getItem("IsHost") == "true")
        {
            statusLabel.textContent = 'Your turn';
        }
        else
        {
            statusLabel.textContent = 'Opponent\'s turn';
        }
        statusLabel.id = 'statusLabel';
        statusLabel.style.position = 'absolute';
        statusLabel.style.top = '700px';


        //DRAW SHIPS


        let info = {
            RoomID : localStorage.getItem('RoomID'),
            PlayerID : localStorage.getItem('UserID')
        }

        let ships = await callAPI("http://localhost:63055/api/Game/GetShips", info);

        let shipLength = 0;
        for(let i = 0; i <= 4; i++)
        {
            switch(i+1)
            {
                case 1:
                    shipLength = 5;
                    break;
                case 2:
                    shipLength = 4;
                    break;
                case 5:
                    shipLength = 2;
                    break;
                case 3:
                    
                case 4: 
                    shipLength = 3;
                    break;

            }
            shipOrientationID = ships[i].ShipOrientationID;
            if(shipOrientationID == 1 || shipOrientationID == 2) //Up or down
            {
                for(let yCoord = asInt(ships[i].StartY); asInt(yCoord) < (asInt(ships[i].StartY) + asInt(shipLength)); yCoord++)
                {
                    let tempCell = document.getElementById(`opponentAttacksx${ships[i].StartX}y${yCoord}`);
                    tempCell.style.backgroundColor = 'DarkBlue';
                    shipCells.set(`opponentAttacksx${ships[i].StartX}y${yCoord}`, 1);
                }
            }
            else if(shipOrientationID == 3 || shipOrientationID == 4)
            {
                for(let xCoord = asInt(ships[i].StartX); asInt(xCoord) < (asInt(ships[i].StartX) + asInt(shipLength)); xCoord++)
                {
                    let tempCell = document.getElementById(`opponentAttacksx${xCoord}y${ships[i].StartY}`);
                    tempCell.style.backgroundColor = 'DarkBlue';
                    shipCells.set(`opponentAttacksx${xCoord}y${ships[i].StartY}`, 1);
                }    
            }
            
        }
    }

    var LastShotID = -1;
    var x = -1;
    var y = -1;

    async function WaitUntilTurn()
    {
        if(!isPlayerTurn)
        {
            let lastShotInfo = 
            {
                RoomID: localStorage.getItem("RoomID"),
                PlayerID: localStorage.getItem("UserID"),
                LastShotID: LastShotID
            };
            //Record the coordinates of the shot and set it to the player's turn
            let checkForShotsInterval;
            
            checkForShotsInterval = window.setInterval(() =>
            {
                const promise = callAPI("http://localhost:63055/api/Game/NewShots", lastShotInfo);
                promise.then((shotCoordinates) =>
                {
                    if(shotCoordinates != null)
                    {
                        if(shotCoordinates[2] != LastShotID)
                        {
                            x = shotCoordinates[0];
                            y = shotCoordinates[1];  
                            LastShotID = (shotCoordinates[2] + 1)*1;

                            let cell = document.getElementById(`opponentAttacksx${x}y${y}`);
                            if(shipCells.get(`opponentAttacksx${x}y${y}`) == 1)
                            {
                                cell.style.backgroundColor = 'Red';
                                opponentHits++;
                            }
                            else if(opponentHits*1 == 17)
                            {
                                alert("You lose!");
                            }
                            else //Miss 
                            {
                                let statusLabel = document.getElementById('statusLabel');
                                statusLabel.textContent= 'Your turn';

                                clearInterval(checkForShotsInterval);
                                isPlayerTurn = true;
                            }
                        }
                    }

                }
                )
            }, 500);
        }
        
    }
    function asInt(value)
    {
        //Casts value as integer
        return value * 1;
    }

    var sunkShip = false; 
    async function fireShot(cellID)
    {
        if(isPlayerTurn == true)
        {
            let cell = document.getElementById(cellID);
            let x = cell.dataset.x;
            let y = cell.dataset.y;

            let info = {
                UserID: localStorage.getItem('UserID'),
                RoomID: localStorage.getItem('RoomID'),
                X: asInt(x),
                Y: asInt(y)
            };
            
            if(cell.dataset.isSelected == "false") //Ensures that the cell hasn't already been selected yet
            {
                cell.dataset.isSelected = "true";
                const promise = callAPI("http://localhost:63055/api/Game/Shoot", info);
                promise.then((message) => 
                {
                    switch(message)
                    {
                        case "Miss":
                            cell.style.backgroundColor = 'Gray';
                            selectedCells.set(cellID, "M");

                            isPlayerTurn = false;
                            let statusLabel = document.getElementById('statusLabel');
                            statusLabel.textContent= 'Opponent\'s turn';
                            WaitUntilTurn();
                        break;

                        case "Hit":
                            cell.style.backgroundColor = 'Red';
                            selectedCells.set(cellID, "H");
                            playerHits++;
                            if(playerHits*1 == 17)
                            {
                                alert("You win!");
                            }
                        break;

                        case "Pre-existing shot":
                            //Do nothing
                        break;

                        default:
                            cell.style.backgroundColor = 'Red';
                            sunkShipTypeID = message;
                            
                        break;
                    }
                });
            }
        }
        else
        {
            alert("Not your turn");
        }
        
    }
    
    function callAPI(url, body)
    {
        return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open(body === undefined ? 'GET' : 'POST', url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onload = () => {
                resolve(JSON.parse(xhr.responseText));
            };

            xhr.onerror = reject;
            xhr.onabort = reject;

            if(body === undefined)
            {
                xhr.send();
            }
            else
            {
                xhr.send(JSON.stringify(body));
            }
        });
    }
</script>